# Distributed Arithmetic Calculator

Содержание:

1. [Структура проекта](#Структура-проекта)
2. [Установка и запуск](#Установка-и-запуск)
3. [API](#API)
4. [Примеры использования](#Примеры-использования)
5. [Возможные ошибки](#Возможные-ошибки)


Этот проект реализует распределённый вычислитель арифметических выражений. Он состоит из двух основных компонентов:

1. **Оркестратор**: Сервер, который принимает арифметическое выражение, переводит его в набор последовательных задач и обеспечивает порядок их выполнения.
2. **Агент**: Демон, который получает задачи от оркестратора, выполняет их и отправляет результаты обратно на сервер.

Каждая операция (сложение, вычитание, умножение, деление) имеет своё время выполнения которое задаётся в переменных среды (в файле .env). Также в переменных среды задаётся колличество горутин-агентов которые будут работать одновременно. Все выражения хранятся в БД SQLite в корне проекта. Оркестратор и агент взаимодействуют по gRPC. Для начала работы нужно зарегестрироваться и авторизоваться. Для безопасного доступа к только своим выражениям используется JWT токен, который выдаётся при входе в аккаунт. Токен действителен 20 минут с момента выдачи.

## Структура проекта

- `agent/` - Код агента.
  - `cmd/agent/` - Точка входа для запуска агента.
  - `internal/app/` - Логика работы агента.
- `orchestrator/` - Код оркестратора.
  - `cmd/calc-service/` - Точка входа для запуска оркестратора.
  - `http/server/` - http сервер.
  - `http/server/handler/` - Обработчики HTTP-запросов.
  - `grpc/server/` - gRPC сервер для отправки и получения даных для и от агента
  - `internal/app/` - Логика обработки выражений.
  - `models/` - Определения структур данных.
- `proto` - все необходимое для работы gRPC
- `.env` - Файл для хранения переменных среды.
- `docker-compose.yml` - докер компуз
- `go.mod` 
- `go.sum`
- `README.MD` - хз зачем он нужен

## Установка и запуск

### Предварительные требования

- Docker

### Установка

Запустить можно только с помощью docker compose

**Вообще docker hub не давно заблокировали в России поэтому перед запуском включите VPN или используйте другое зеркало.**

Скопируйте репозиторий и запустите с помощью docker compose:
```sh
docker compose up
```

## API

1. Регистрация пользователя
```sh
curl --location 'localhost:8080/api/v1/register' \
--header 'Content-Type: application/json' \
--data '{
      "name": "<имя пользователя>",
      "password": "<пароль>"
}'
```

2. Авторизация пользователя и выдыча JWT токена для взаимодействия с проектом
```sh
curl --location 'localhost:8080/api/v1/login' \
--header 'Content-Type: application/json' \
--data '{
      "name": "<имя пользователя>",
      "password": "<пароль>"
}'
```

3. Добавление вычисления арифметического выражения
```sh
curl --location 'localhost:8080/api/v1/calculate' \
--header 'Content-Type: application/json' \
--data '{
      "id": "<уникальный идентификатор выражения>",
      "expression": "<строка с выражением>", 
      "token": "<токен который был выдан при авторизации>"
}'
```

4. Получение списка выражений которые отправляли вы
```sh
curl --location 'localhost:8080/api/v1/expressions' \
--header 'Content-Type: application/json' \
--data '{
      "token": "<токен который был выдан при авторизации>"
}'
```

5. Получение вышего выражения по его идентификатору
```sh
curl --location 'localhost:8080/api/v1/expressions/<id выражения>' \
--header 'Content-Type: application/json' \
--data '{
      "token": "<токен который был выдан при авторизации>"
}'
```

## Примеры использования 
1. Зарегестрируйтесь
```sh
curl --location 'localhost:8080/api/v1/register' \
--header 'Content-Type: application/json' \
--data '{
      "name": "user",
      "password": "1234"
}'
```

2. Авторизуйтесь и получите токен
```sh
curl --location 'localhost:8080/api/v1/login' \
--header 'Content-Type: application/json' \
--data '{
      "name": "user",
      "password": "1234"
}'
```
Вывод:
```json
{"token":"<тут будет ваш токен>"}
```

3. Добавьте выражение на вычисление.
```sh
curl --location 'localhost:8080/api/v1/calculate' \
--header 'Content-Type: application/json' \
--data '{
      "id": "1",
      "expression": "2 + 2 * 2",
      "token": "<тут будет ваш токен>"
}'
```

4. Получение списка ваших выражений
```sh
curl --location 'localhost:8080/api/v1/expressions' \
--header 'Content-Type: application/json' \
--data '{
      "token": "<токен который был выдан при авторизации>"
}'
```
Вывод:
```json
{"expressions":[{"id":"1","expression":"2 + 2 * 2","status":"completed","result":6}]}
```

5. Получение выражения по его идентификатору
```sh
curl --location 'localhost:8080/api/v1/expressions/1' \
--header 'Content-Type: application/json' \
--data '{
      "token": "<токен который был выдан при авторизации>"
}'
```
Вывод:
```json
{"expression":{"id":"1","expression":"2 + 2 * 2","status":"completed","result":"6"}}
```