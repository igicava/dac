# Distributed Arithmetic Calculator

Содержание:

1. [Структура проекта](#Структура-проекта)
2. [Установка и запуск](#Установка-и-запуск)
3. [Запуск с помощью docker compose](#Запуск-с-помощью-docker-compose)
4. [API](#API)
5. [Примеры использования](#Примеры-использования)
6. [Возможные ошибки](#Возможные-ошибки)


Этот проект реализует распределённый вычислитель арифметических выражений. Он состоит из двух основных компонентов:

1. **Оркестратор**: Сервер, который принимает арифметическое выражение, переводит его в набор последовательных задач и обеспечивает порядок их выполнения.
2. **Агент**: Демон, который получает задачи от оркестратора, выполняет их и отправляет результаты обратно на сервер.

Каждая операция (сложение, вычитание, умножение, деление) имеет своё время выполнения которое задаётся в переменных среды (в файле .env). Поэтому запускать оркестратора и агента нужно ИМЕННО ТАК КАК ПОКАЗАНО В ИНСТРУКЦИИ. Также в переменных среды задаётся колличество горутин-агентов которые будут работать одновременно.

## Структура проекта

- `agent/` - Код агента.
  - `cmd/agent/` - Точка входа для запуска агента.
  - `internal/app/` - Логика работы агента.
- `orchestrator/` - Код оркестратора.
  - `cmd/calc-service/` - Точка входа для запуска оркестратора.
  - `http/server/handler/` - Обработчики HTTP-запросов.
  - `internal/app/` - Логика обработки выражений.
  - `models/` - Определения структур данных.
- `.env` - Файл для хранения переменных среды.

## Установка и запуск

### Предварительные требования

- Go 1.22
- Это не требование, но удобнее всего использовать проект будет на каком либо Linux дистрибутиве или WSL

### Установка

1. Клонируйте репозиторий:
```sh
git clone https://github.com/igicava/dac.git
```

2. Перейдите в проект:
```sh
cd dac
```

3. Установите зависимости:
```sh
go mod tidy
```

### Запуск оркестратора
Запустите оркестратор:

```sh
go run orchestrator/cmd/calc-service/main.go
```

### Запуск агента
После запуска оркестратора нужно запустить агента. Создайте 2 терминал и перейдите в КОРНЕВУЮ дирректорию проекта. И запустите агента:
```sh
go run agent/cmd/agent/main.go
```

### Примечание
Если вы будете запускать агента или аркестратора не как в инструкции (например напрямую не из корневой дирректории: go run cmd/agent/main.go), то вы не сможете запустить проект из за того что файл с переменными среды не будет найден.

## Запуск с помощью docker compose
**Вообще docker hub не давно заблокировали в России поэтому перед запуском включите VPN или используйте другое зеркало.**

1. Для запуска с помощью docker compose клонируйте репозиторий:
```sh
git clone https://github.com/igicava/dac.git
```

2. Потом перейдите в проект:
```sh
cd dac
```

3. И запустите с помощью docker compose:
```sh
docker compose up
```

## API
### Оркестратор
1. Добавление вычисления арифметического выражения
```sh
curl --location 'localhost:8080/api/v1/calculate' \
--header 'Content-Type: application/json' \
--data '{
      "id": "<уникальный идентификатор выражения>",
      "expression": "<строка с выражением>"
}'
```

2. Получение списка выражений
```sh
curl --location 'localhost:8080/api/v1/expressions'
```

3. Получение выражения по его идентификатору
```sh
curl --location 'localhost:8080/api/v1/expressions/<id выражения>'
```

4. Получение задачи для выполнения (для агента)
```sh
curl --location 'localhost:8080/internal/task'
```

5. Прием результата обработки данных (от агента)
```sh
curl --location 'localhost:8080/internal/task' \
--header 'Content-Type: application/json' \
--data '{
      "id": "<идентификатор задачи>",
      "result": <результат>
}'
```

## Примеры использования 
1. Добавление вычисления арифметического выражения
```sh
curl --location 'localhost:8080/api/v1/calculate' \
--header 'Content-Type: application/json' \
--data '{
      "id": "1",
      "expression": "2 + 2 * 2"
}'
```

2. Получение списка выражений
```sh
curl --location 'localhost:8080/api/v1/expressions'
```
Вывод:
```json
{"expressions":[{"id":"1","expression":"2 + 2 * 2","status":"completed","result":6}]}
```

3. Получение выражения по его идентификатору
```sh
curl --location 'localhost:8080/api/v1/expressions/1'
```
Вывод:
```json
{"expression":{"id":"1","expression":"2 + 2 * 2","status":"completed","result":6}}
```

## Возможные ошибки:

Помните, что чаще всего возможные ошибки исправляются установкой версии Go 1.22.3 если вы запускаете обычным способом. Если вы запускаете с помощью docker compose и у вас возникает ошибка сборки попробуйте использовать VPN, т.к. docker hub заблокирован в России.